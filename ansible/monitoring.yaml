---
- name: Deploy Prometheus and Grafana Monitoring
  hosts: localhost
  connection: local
  gather_facts: yes
  vars_files:
    - group_vars/all.yml

  vars:
    monitoring_namespace: monitoring
    terraform_dir: "../infra"
    k8s_manifests_dir: "../k8s"

  tasks:
    - name: Display monitoring deployment info
      debug:
        msg:
          - "Deploying Prometheus and Grafana"
          - "Namespace: {{ monitoring_namespace }}"
          - "Region: {{ aws_region }}"

    - name: Get Terraform outputs
      shell: |
        cd {{ terraform_dir }}
        terraform output -json
      register: terraform_output
      changed_when: false
      failed_when: false

    - name: Parse EKS cluster name
      set_fact:
        eks_cluster_name: "{{ (terraform_output.stdout | from_json).eks_cluster_name.value }}"
      when: terraform_output.stdout is defined and terraform_output.stdout != ""

    - name: Configure kubectl
      shell: |
        aws eks update-kubeconfig --region {{ aws_region }} --name {{ eks_cluster_name }}
      changed_when: false
      when: eks_cluster_name is defined

    - name: Create namespaces (includes monitoring)
      command: kubectl apply -f {{ k8s_manifests_dir }}/namespace.yaml
      register: ns_result

    - name: Display namespace result
      debug:
        var: ns_result.stdout_lines

    - name: Wait for monitoring namespace to be active
      shell: |
        kubectl wait --for=jsonpath='{.status.phase}'=Active namespace/{{ monitoring_namespace }} --timeout=30s
      register: namespace_wait
      changed_when: false
      failed_when: false

    - name: Apply ConfigMap (includes prometheus-config)
      command: kubectl apply -f {{ k8s_manifests_dir }}/configmap.yaml
      register: configmap_result

    - name: Display ConfigMap result
      debug:
        var: configmap_result.stdout_lines

    - name: Deploy Node Exporter DaemonSet
      command: kubectl apply -f {{ k8s_manifests_dir }}/node-exporter.yaml
      register: node_exporter_result

    - name: Display Node Exporter result
      debug:
        var: node_exporter_result.stdout_lines

    - name: Wait for Node Exporter to be ready
      shell: |
        kubectl rollout status daemonset/node-exporter -n {{ monitoring_namespace }} --timeout=120s
      register: node_exporter_status
      retries: 3
      delay: 10
      failed_when: false

    - name: Display Node Exporter status
      debug:
        msg: "✓ Node Exporter DaemonSet is ready"
      when: node_exporter_status.rc == 0

    - name: Apply monitoring deployment
      command: kubectl apply -f {{ k8s_manifests_dir }}/deployment-monitoring.yaml
      register: monitoring_result

    - name: Display monitoring deployment result
      debug:
        var: monitoring_result.stdout_lines

    - name: Wait for Prometheus to be ready
      shell: |
        kubectl wait --for=condition=available --timeout=180s deployment/prometheus -n {{ monitoring_namespace }}
      register: prometheus_status
      retries: 3
      delay: 10

    - name: Display Prometheus status
      debug:
        msg: "✓ Prometheus is ready"
      when: prometheus_status.rc == 0

    - name: Wait for Grafana to be ready
      shell: |
        kubectl wait --for=condition=available --timeout=180s deployment/grafana -n {{ monitoring_namespace }}
      register: grafana_status
      retries: 3
      delay: 10

    - name: Display Grafana status
      debug:
        msg: "✓ Grafana is ready"
      when: grafana_status.rc == 0

    - name: Restart Prometheus to pick up new config
      shell: |
        kubectl rollout restart deployment/prometheus -n {{ monitoring_namespace }}
      register: prometheus_restart

    - name: Wait for Prometheus restart to complete
      shell: |
        kubectl rollout status deployment/prometheus -n {{ monitoring_namespace }} --timeout=120s
      register: prometheus_restart_status
      failed_when: false

    - name: Verify Node Exporter pods are running
      shell: |
        kubectl get pods -n {{ monitoring_namespace }} -l app=node-exporter -o wide
      register: node_exporter_pods
      changed_when: false

    - name: Display Node Exporter pods
      debug:
        var: node_exporter_pods.stdout_lines

    - name: Get Prometheus LoadBalancer URL
      shell: |
        kubectl get svc prometheus-service -n {{ monitoring_namespace }} \
          -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
      register: prometheus_lb
      changed_when: false
      retries: 10
      delay: 15
      until: prometheus_lb.stdout != ""

    - name: Get Grafana LoadBalancer URL
      shell: |
        kubectl get svc grafana-service -n {{ monitoring_namespace }} \
          -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
      register: grafana_lb
      changed_when: false
      retries: 10
      delay: 15
      until: grafana_lb.stdout != ""

    - name: Get Grafana admin password
      shell: |
        kubectl get secret grafana-credentials -n {{ monitoring_namespace }} \
          -o jsonpath='{.data.admin-password}' | base64 --decode
      register: grafana_password
      changed_when: false

    - name: Verify Prometheus targets
      shell: |
        sleep 30
        curl -s http://{{ prometheus_lb.stdout }}:9090/api/v1/targets | python3 -c "import sys,json; d=json.load(sys.stdin); print('Active targets:', len([t for t in d.get('data',{}).get('activeTargets',[]) if t.get('health')=='up']))"
      register: prometheus_targets
      changed_when: false
      failed_when: false
      when: prometheus_lb.stdout != ""

    - name: Display Prometheus targets
      debug:
        var: prometheus_targets.stdout
      when: prometheus_targets.stdout is defined

    - name: Monitoring Deployment Summary
      debug:
        msg:
          - "=========================================="
          - "Monitoring Stack Deployed Successfully"
          - "=========================================="
          - "Prometheus URL: http://{{ prometheus_lb.stdout }}:9090"
          - "Grafana URL: http://{{ grafana_lb.stdout }}:3000"
          - "Grafana Username: admin"
          - "Grafana Password: {{ grafana_password.stdout }}"
          - "=========================================="
          - "Prometheus Targets: http://{{ prometheus_lb.stdout }}:9090/targets"
          - "=========================================="
          - "To use Dashboard 1860 (Node Exporter Full):"
          - "1.Open Grafana URL in browser"
          - "2.Go to Dashboards -> Import"
          - "3.Enter ID: 1860"
          - "4.Select Prometheus datasource"
          - "5.Click Import"
          - "=========================================="
